const packsDiv = document.getElementById("packs");
const instructions = document.getElementById("instructions");

// Make sure packs are hidden on first load
packsDiv.style.display = "none";
instructions.textContent = "Connect your Discord to see donation packs!";

// Function to show connected state
function showConnected(user) {
  discordBtn.textContent = `Connected: ${user}`;
  discordBtn.style.background = "transparent";
  packsDiv.style.display = "grid";
  instructions.textContent = "Select a pack to pay!";
}

// Disconnect function
function disconnect() {
  localStorage.removeItem("discordTag");
  discordBtn.textContent = "Connect Discord";
  discordBtn.style.background = "";
  packsDiv.style.display = "none";
  instructions.textContent = "Connect your Discord to see donation packs!";
}

// Connect / Disconnect button logic
discordBtn.onclick = () => {
  if (localStorage.discordTag) {
    if (confirm("Disconnect your Discord account?")) {
      disconnect();
    }
    return;
  }
  const url = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT}&response_type=token&scope=identify`;
  window.location.href = url;
};

// Handle OAuth redirect
if (location.hash.includes("access_token")) {
  const token = new URLSearchParams(location.hash.slice(1)).get("access_token");
  fetch("https://discord.com/api/users/@me", {
    headers: { Authorization: `Bearer ${token}` }
  })
  .then(r => r.json())
  .then(user => {
    localStorage.discordTag = user.username;
    showConnected(user.username);
    history.replaceState({}, "", location.pathname);
  })
  .catch(err => alert("Failed to connect: " + err.message));
}

// Show connected if already in localStorage
if (localStorage.discordTag) {
  showConnected(localStorage.discordTag);
}
